
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crm_utils &#8212; Mox KMD EE 0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crm_utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Utility functions etc. based on the CRM data model and mapped to LoRa.&quot;&quot;&quot;</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2017, Magenta ApS</span>
<span class="c1">#</span>
<span class="c1"># This Source Code Form is subject to the terms of the Mozilla Public</span>
<span class="c1"># License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<span class="c1"># file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">pytz</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">serviceplatformen_cpr</span> <span class="k">import</span> <span class="n">get_cpr_data</span>
<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The SP CPR API wasn&#39;t configured - this can happen when testing etc.&quot;&quot;&quot;</span>
<div class="viewcode-block" id="get_cpr_data"><a class="viewcode-back" href="../crm_utils.html#crm_utils.get_cpr_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_cpr_data</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dummy implementation for dry runs.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<span class="kn">from</span> <span class="nn">ee_oio</span> <span class="k">import</span> <span class="n">lookup_bruger</span><span class="p">,</span> <span class="n">lookup_organisation</span><span class="p">,</span> <span class="n">lookup_klasse</span>
<span class="kn">from</span> <span class="nn">ee_oio</span> <span class="k">import</span> <span class="n">lookup_interessefaellesskab</span><span class="p">,</span> <span class="n">lookup_organisationfunktioner</span>
<span class="kn">from</span> <span class="nn">ee_oio</span> <span class="k">import</span> <span class="n">lookup_organisationfunktion</span><span class="p">,</span> <span class="n">lookup_indsats</span>
<span class="kn">from</span> <span class="nn">ee_oio</span> <span class="k">import</span> <span class="n">lookup_indsatser</span><span class="p">,</span> <span class="n">delete_object</span><span class="p">,</span> <span class="n">read_object</span><span class="p">,</span> <span class="n">create_klasse</span>
<span class="kn">from</span> <span class="nn">ee_oio</span> <span class="k">import</span> <span class="n">create_organisation</span><span class="p">,</span> <span class="n">create_bruger</span><span class="p">,</span> <span class="n">create_indsats</span>
<span class="kn">from</span> <span class="nn">ee_oio</span> <span class="k">import</span> <span class="n">create_interessefaellesskab</span><span class="p">,</span> <span class="n">create_organisationfunktion</span>
<span class="kn">from</span> <span class="nn">ee_oio</span> <span class="k">import</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">KUNDE</span><span class="p">,</span> <span class="n">LIGESTILLINGSKUNDE</span>
<span class="kn">from</span> <span class="nn">ee_oio</span> <span class="k">import</span> <span class="n">write_object</span><span class="p">,</span> <span class="n">write_object_dict</span>
<span class="kn">from</span> <span class="nn">ee_utils</span> <span class="k">import</span> <span class="n">is_cvr</span><span class="p">,</span> <span class="n">is_cpr</span><span class="p">,</span> <span class="n">int_str</span><span class="p">,</span> <span class="n">cpr_cvr</span>
<span class="kn">from</span> <span class="nn">ee_utils</span> <span class="k">import</span> <span class="n">get_forbrugssted_address_uuid</span>
<span class="kn">from</span> <span class="nn">service_clients</span> <span class="k">import</span> <span class="n">report_error</span><span class="p">,</span> <span class="n">get_cvr_data</span><span class="p">,</span> <span class="n">get_address_uuid</span>
<span class="kn">from</span> <span class="nn">service_clients</span> <span class="k">import</span> <span class="n">fuzzy_address_uuid</span>

<span class="n">VARME</span> <span class="o">=</span> <span class="s2">&quot;Varme&quot;</span>

<span class="c1"># Delete functions</span>
<span class="n">delete_customer_relation</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
    <span class="n">delete_object</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s1">&#39;organisation&#39;</span><span class="p">,</span> <span class="n">oio_class</span><span class="o">=</span><span class="s1">&#39;interessefaellesskab&#39;</span>
<span class="p">)</span>
<span class="n">delete_customer_role</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
    <span class="n">delete_object</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s1">&#39;organisation&#39;</span><span class="p">,</span> <span class="n">oio_class</span><span class="o">=</span><span class="s1">&#39;organisationfunktion&#39;</span>
<span class="p">)</span>
<span class="n">delete_agreement</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
    <span class="n">delete_object</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s1">&#39;indsats&#39;</span><span class="p">,</span> <span class="n">oio_class</span><span class="o">=</span><span class="s1">&#39;indsats&#39;</span>
<span class="p">)</span>
<span class="n">delete_product</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
    <span class="n">delete_object</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s1">&#39;klassifikation&#39;</span><span class="p">,</span> <span class="n">oio_class</span><span class="o">=</span><span class="s1">&#39;klasse&#39;</span>
<span class="p">)</span>


<span class="c1"># Read functions</span>
<span class="n">read_agreement</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
    <span class="n">read_object</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s1">&#39;indsats&#39;</span><span class="p">,</span> <span class="n">oio_class</span><span class="o">=</span><span class="s1">&#39;indsats&#39;</span>
<span class="p">)</span>


<span class="c1"># Lookup of one object</span>
<div class="viewcode-block" id="lookup_customer_from_cvr"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_customer_from_cvr">[docs]</a><span class="k">def</span> <span class="nf">lookup_customer_from_cvr</span><span class="p">(</span><span class="n">id_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look up customer from the CVR number of its Virksomhed.&quot;&quot;&quot;</span>
    <span class="n">urn</span> <span class="o">=</span> <span class="s1">&#39;urn:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lookup_organisation</span><span class="p">(</span><span class="n">virksomhed</span><span class="o">=</span><span class="n">urn</span><span class="p">)</span></div>


<div class="viewcode-block" id="lookup_customer_from_cpr"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_customer_from_cpr">[docs]</a><span class="k">def</span> <span class="nf">lookup_customer_from_cpr</span><span class="p">(</span><span class="n">id_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look up customer (user) from CPR number.&quot;&quot;&quot;</span>
    <span class="n">urn</span> <span class="o">=</span> <span class="s1">&#39;urn:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lookup_bruger</span><span class="p">(</span><span class="n">tilknyttedepersoner</span><span class="o">=</span><span class="n">urn</span><span class="p">)</span></div>


<div class="viewcode-block" id="lookup_customer"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_customer">[docs]</a><span class="k">def</span> <span class="nf">lookup_customer</span><span class="p">(</span><span class="n">id_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look up customer by ID number.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_cpr</span><span class="p">(</span><span class="n">id_number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lookup_customer_from_cpr</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_cvr</span><span class="p">(</span><span class="n">id_number</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">lookup_customer_from_cvr</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span></div>


<div class="viewcode-block" id="lookup_customer_relation"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_customer_relation">[docs]</a><span class="k">def</span> <span class="nf">lookup_customer_relation</span><span class="p">(</span><span class="n">customer_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look up customer relations belonging to customer number.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lookup_interessefaellesskab</span><span class="p">(</span><span class="n">brugervendtnoegle</span><span class="o">=</span><span class="n">customer_number</span><span class="p">)</span></div>


<div class="viewcode-block" id="lookup_customer_role"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_customer_role">[docs]</a><span class="k">def</span> <span class="nf">lookup_customer_role</span><span class="p">(</span><span class="n">customer_relation</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look up customer role from customer and role specification.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lookup_organisationfunktion</span><span class="p">(</span>
        <span class="n">tilknyttedeinteressefaellesskaber</span><span class="o">=</span><span class="n">customer_relation</span><span class="p">,</span>
        <span class="n">funktionsnavn</span><span class="o">=</span><span class="n">role</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="lookup_product"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_product">[docs]</a><span class="k">def</span> <span class="nf">lookup_product</span><span class="p">(</span><span class="n">productid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look up product (installation and meter) from ID.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lookup_klasse</span><span class="p">(</span><span class="n">brugervendtnoegle</span><span class="o">=</span><span class="n">productid</span><span class="p">)</span></div>


<div class="viewcode-block" id="lookup_agreement_from_product"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_agreement_from_product">[docs]</a><span class="k">def</span> <span class="nf">lookup_agreement_from_product</span><span class="p">(</span><span class="n">product_uuid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lookup agreement from the UUID of a product.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lookup_indsats</span><span class="p">(</span><span class="n">indsatskvalitet</span><span class="o">=</span><span class="n">product_uuid</span><span class="p">)</span></div>


<span class="c1"># Lookup of more than one object</span>
<div class="viewcode-block" id="lookup_customer_roles"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_customer_roles">[docs]</a><span class="k">def</span> <span class="nf">lookup_customer_roles</span><span class="p">(</span><span class="n">customer_relation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find all customer roles for a given customer relation.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lookup_organisationfunktioner</span><span class="p">(</span>
        <span class="n">tilknyttedeinteressefaellesskaber</span><span class="o">=</span><span class="n">customer_relation</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="lookup_agreements"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_agreements">[docs]</a><span class="k">def</span> <span class="nf">lookup_agreements</span><span class="p">(</span><span class="n">customer_relation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lookup agreement(s) for customer relation, by UUID.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">lookup_indsatser</span><span class="p">(</span><span class="n">indsatsmodtager</span><span class="o">=</span><span class="n">customer_relation</span><span class="p">)</span></div>


<div class="viewcode-block" id="lookup_products"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_products">[docs]</a><span class="k">def</span> <span class="nf">lookup_products</span><span class="p">(</span><span class="n">agreement_uuid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get products for this agreement.&quot;&quot;&quot;</span>
    <span class="c1"># FIXME: This is bothersome, because we actually have to load the agreement</span>
    <span class="c1"># to find the products. The correct way would be to do as we do in Arosia</span>
    <span class="c1"># and have an AVA specific relation from Klasse to Indsats.</span>
    <span class="n">agreement</span> <span class="o">=</span> <span class="n">read_agreement</span><span class="p">(</span><span class="n">agreement_uuid</span><span class="p">)</span>
    <span class="n">indsatskvalitet</span> <span class="o">=</span> <span class="n">agreement</span><span class="p">[</span><span class="s1">&#39;relationer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indsatskvalitet&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">product_uuids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indsatskvalitet</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">product_uuids</span></div>


<span class="c1"># Write functions</span>

<span class="n">write_agreement_dict</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">write_object_dict</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="s1">&#39;indsats&#39;</span><span class="p">,</span>
                                         <span class="n">oio_class</span><span class="o">=</span><span class="s1">&#39;indsats&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="add_product_to_agreement"><a class="viewcode-back" href="../crm_utils.html#crm_utils.add_product_to_agreement">[docs]</a><span class="k">def</span> <span class="nf">add_product_to_agreement</span><span class="p">(</span><span class="n">product_uuid</span><span class="p">,</span> <span class="n">agreement_uuid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add product to agreement.&quot;&quot;&quot;</span>
    <span class="n">relations</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;indsatskvalitet&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">Relation</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">product_uuid</span><span class="p">)]}</span>
    <span class="n">write_object</span><span class="p">(</span><span class="n">agreement_uuid</span><span class="p">,</span> <span class="p">{},</span> <span class="n">relations</span><span class="p">,</span> <span class="s1">&#39;indsats&#39;</span><span class="p">,</span> <span class="s1">&#39;indsats&#39;</span><span class="p">)</span></div>


<span class="c1"># Address lookup</span>
<div class="viewcode-block" id="lookup_address_from_sp_data"><a class="viewcode-back" href="../crm_utils.html#crm_utils.lookup_address_from_sp_data">[docs]</a><span class="k">def</span> <span class="nf">lookup_address_from_sp_data</span><span class="p">(</span><span class="n">sp_dict</span><span class="p">,</span> <span class="n">id_number</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lookup DAWA address from data returned by SP.&quot;&quot;&quot;</span>
    <span class="n">address</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s2">&quot;vejkode&quot;</span> <span class="ow">in</span> <span class="n">sp_dict</span><span class="p">:</span>
        <span class="n">address</span><span class="p">[</span><span class="s2">&quot;vejkode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp_dict</span><span class="p">[</span><span class="s2">&quot;vejkode&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;postnummer&quot;</span> <span class="ow">in</span> <span class="n">sp_dict</span><span class="p">:</span>
        <span class="n">address</span><span class="p">[</span><span class="s2">&quot;postnr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp_dict</span><span class="p">[</span><span class="s2">&quot;postnummer&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;etage&quot;</span> <span class="ow">in</span> <span class="n">sp_dict</span><span class="p">:</span>
        <span class="n">address</span><span class="p">[</span><span class="s2">&quot;etage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp_dict</span><span class="p">[</span><span class="s2">&quot;etage&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;sidedoer&quot;</span> <span class="ow">in</span> <span class="n">sp_dict</span><span class="p">:</span>
        <span class="n">address</span><span class="p">[</span><span class="s2">&quot;dør&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp_dict</span><span class="p">[</span><span class="s2">&quot;sidedoer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;husnummer&quot;</span> <span class="ow">in</span> <span class="n">sp_dict</span><span class="p">:</span>
        <span class="n">address</span><span class="p">[</span><span class="s2">&quot;husnr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp_dict</span><span class="p">[</span><span class="s2">&quot;husnummer&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">address_uuid</span> <span class="o">=</span> <span class="n">get_address_uuid</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">report_error</span><span class="p">(</span>
            <span class="s2">&quot;Unable to lookup address for </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">id_number</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="p">),</span> <span class="n">error_stack</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">address_uuid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">address_uuid</span></div>


<span class="c1"># Create functions</span>
<div class="viewcode-block" id="create_customer"><a class="viewcode-back" href="../crm_utils.html#crm_utils.create_customer">[docs]</a><span class="k">def</span> <span class="nf">create_customer</span><span class="p">(</span><span class="n">id_number</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">master_id</span><span class="p">,</span> <span class="n">phone</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">mobile</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fax</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create customer from data extracted from KMD EE.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">is_cvr</span><span class="p">(</span><span class="n">id_number</span><span class="p">):</span>

        <span class="c1"># Collect info from SP and include in call creating user.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">company_dir</span> <span class="o">=</span> <span class="n">get_cvr_data</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Retry *once*</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">company_dir</span> <span class="o">=</span> <span class="n">get_cvr_data</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">report_error</span><span class="p">(</span>
                    <span class="s2">&quot;CVR number </span><span class="si">{0}</span><span class="s2"> not found: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_number</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">company_dir</span><span class="p">[</span><span class="s1">&#39;organisationsnavn&#39;</span><span class="p">]</span>
        <span class="n">address_uuid</span> <span class="o">=</span> <span class="n">company_dir</span><span class="p">[</span><span class="s1">&#39;dawa_uuid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address_uuid</span><span class="p">:</span>
            <span class="n">address_uuid</span> <span class="o">=</span> <span class="n">lookup_address_from_sp_data</span><span class="p">(</span><span class="n">company_dir</span><span class="p">,</span> <span class="n">id_number</span><span class="p">)</span>
        <span class="n">company_type</span> <span class="o">=</span> <span class="n">company_dir</span><span class="p">[</span><span class="s1">&#39;virksomhedsform&#39;</span><span class="p">]</span>
        <span class="n">industry_code</span> <span class="o">=</span> <span class="n">company_dir</span><span class="p">[</span><span class="s1">&#39;branchekode&#39;</span><span class="p">]</span>
        <span class="n">address_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2">, </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">company_dir</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vejnavn&#39;</span><span class="p">),</span> <span class="n">company_dir</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;husnummer&#39;</span><span class="p">),</span>
            <span class="n">company_dir</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;postnummer&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">create_organisation</span><span class="p">(</span>
            <span class="n">id_number</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">master_id</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">mobile</span><span class="p">,</span> <span class="n">fax</span><span class="p">,</span>
            <span class="n">address_uuid</span><span class="p">,</span> <span class="n">company_type</span><span class="p">,</span> <span class="n">industry_code</span><span class="p">,</span> <span class="n">note</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">is_cpr</span><span class="p">(</span><span class="n">id_number</span><span class="p">):</span>
        <span class="c1"># This is a CPR number</span>

        <span class="c1"># Collect info from SP and include in call creating user.</span>
        <span class="c1"># Avoid getting throttled by SP</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">person_dir</span> <span class="o">=</span> <span class="n">get_cpr_data</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;SP CPR Lookup failed, ID: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>

            <span class="c1"># Retry *once*</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">person_dir</span> <span class="o">=</span> <span class="n">get_cpr_data</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Hotfix:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CPR lookup failed after retrying:&quot;</span><span class="p">,</span> <span class="n">id_number</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="c1"># Certain CPR ID&#39;s are actually P-Numbers</span>
                <span class="c1"># These must be manually processed</span>
                <span class="n">report_error</span><span class="p">(</span>
                    <span class="n">error_message</span><span class="o">=</span><span class="n">error_message</span><span class="p">,</span>
                    <span class="n">error_object</span><span class="o">=</span><span class="n">id_number</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">first_name</span> <span class="o">=</span> <span class="n">person_dir</span><span class="p">[</span><span class="s1">&#39;fornavn&#39;</span><span class="p">]</span>
        <span class="n">middle_name</span> <span class="o">=</span> <span class="n">person_dir</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mellemnavn&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">last_name</span> <span class="o">=</span> <span class="n">person_dir</span><span class="p">[</span><span class="s1">&#39;efternavn&#39;</span><span class="p">]</span>

        <span class="n">address_uuid</span> <span class="o">=</span> <span class="n">lookup_address_from_sp_data</span><span class="p">(</span><span class="n">person_dir</span><span class="p">,</span> <span class="n">id_number</span><span class="p">)</span>
        <span class="c1"># Cache address for customer relation</span>
        <span class="n">address_string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">person_dir</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;standardadresse&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Hotfix:</span>
        <span class="k">if</span> <span class="s1">&#39;postnummer&#39;</span> <span class="ow">in</span> <span class="n">person_dir</span><span class="p">:</span>
            <span class="n">address_string</span> <span class="o">+=</span> <span class="s2">&quot;, </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">person_dir</span><span class="p">[</span><span class="s1">&#39;postnummer&#39;</span><span class="p">])</span>

        <span class="n">gender</span> <span class="o">=</span> <span class="n">person_dir</span><span class="p">[</span><span class="s1">&#39;koen&#39;</span><span class="p">]</span>
        <span class="n">marital_status</span> <span class="o">=</span> <span class="n">person_dir</span><span class="p">[</span><span class="s1">&#39;civilstand&#39;</span><span class="p">]</span>
        <span class="n">address_protection</span> <span class="o">=</span> <span class="n">person_dir</span><span class="p">[</span><span class="s1">&#39;adressebeskyttelse&#39;</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">create_bruger</span><span class="p">(</span>
            <span class="n">id_number</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">master_id</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">mobile</span><span class="p">,</span> <span class="n">fax</span><span class="p">,</span>
            <span class="n">first_name</span><span class="p">,</span> <span class="n">middle_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">address_uuid</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span>
            <span class="n">marital_status</span><span class="p">,</span> <span class="n">address_protection</span><span class="p">,</span> <span class="n">note</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">report_error</span><span class="p">(</span><span class="s2">&quot;Forkert CPR/SE-nr for </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">id_number</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Invalid customer</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="create_customer_role"><a class="viewcode-back" href="../crm_utils.html#crm_utils.create_customer_role">[docs]</a><span class="k">def</span> <span class="nf">create_customer_role</span><span class="p">(</span><span class="n">customer_uuid</span><span class="p">,</span> <span class="n">customer_relation_uuid</span><span class="p">,</span> <span class="n">role</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an OrgFunktion from this info and return UUID.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">create_organisationfunktion</span><span class="p">(</span>
        <span class="n">customer_uuid</span><span class="p">,</span>
        <span class="n">customer_relation_uuid</span><span class="p">,</span>
        <span class="n">role</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="create_customer_relation"><a class="viewcode-back" href="../crm_utils.html#crm_utils.create_customer_relation">[docs]</a><span class="k">def</span> <span class="nf">create_customer_relation</span><span class="p">(</span><span class="n">customer_number</span><span class="p">,</span> <span class="n">customer_relation_name</span><span class="p">,</span>
                             <span class="n">customer_type</span><span class="p">,</span> <span class="n">address_uuid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an Interessefællesskab from this info and return UUID.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">create_interessefaellesskab</span><span class="p">(</span>
        <span class="n">customer_number</span><span class="p">,</span>
        <span class="n">customer_relation_name</span><span class="p">,</span>
        <span class="n">customer_type</span><span class="p">,</span>
        <span class="n">address_uuid</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="create_agreement"><a class="viewcode-back" href="../crm_utils.html#crm_utils.create_agreement">[docs]</a><span class="k">def</span> <span class="nf">create_agreement</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">agreement_type</span><span class="p">,</span> <span class="n">no_of_products</span><span class="p">,</span> <span class="n">invoice_address</span><span class="p">,</span>
                     <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span>
                     <span class="n">customer_relation_uuid</span><span class="p">,</span> <span class="n">product_uuids</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an Indsats from this info and return UUID.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">create_indsats</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">agreement_type</span><span class="p">,</span> <span class="n">no_of_products</span><span class="p">,</span>
                            <span class="n">invoice_address</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span>
                            <span class="n">location</span><span class="p">,</span> <span class="n">customer_relation_uuid</span><span class="p">,</span> <span class="n">product_uuids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="create_product"><a class="viewcode-back" href="../crm_utils.html#crm_utils.create_product">[docs]</a><span class="k">def</span> <span class="nf">create_product</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">identification</span><span class="p">,</span> <span class="n">installation_type</span><span class="p">,</span> <span class="n">meter_number</span><span class="p">,</span>
                   <span class="n">meter_type</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">product_address</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a Klasse from this info and return UUID.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">create_klasse</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">identification</span><span class="p">,</span> <span class="n">installation_type</span><span class="p">,</span>
                           <span class="n">meter_number</span><span class="p">,</span> <span class="n">meter_type</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span>
                           <span class="n">product_address</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="update_product"><a class="viewcode-back" href="../crm_utils.html#crm_utils.update_product">[docs]</a><span class="k">def</span> <span class="nf">update_product</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">new_values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update product with new information.&quot;&quot;&quot;</span>
    <span class="n">name_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Målernr&#39;</span><span class="p">,</span> <span class="s1">&#39;Målertypefabrikat&#39;</span><span class="p">,</span> <span class="s1">&#39;MaalerTypeBetegnel&#39;</span><span class="p">}</span>
    <span class="n">alt_place</span> <span class="o">=</span> <span class="s1">&#39;AlternativStedID&#39;</span>

    <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">relations</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">all_fields</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">new_values</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">name_fields</span> <span class="o">&amp;</span> <span class="n">new_values</span><span class="o">.</span><span class="n">keys</span><span class="p">:</span>
        <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;eksempel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_fields</span><span class="p">[</span><span class="s1">&#39;Målernr&#39;</span><span class="p">]</span>
        <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;beskrivelse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_fields</span><span class="p">[</span><span class="s1">&#39;MaalerTypeBetegnel&#39;</span><span class="p">]</span>
        <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">all_fields</span><span class="p">[</span><span class="s1">&#39;Målernr&#39;</span><span class="p">],</span> <span class="n">all_fields</span><span class="p">[</span><span class="s1">&#39;Målertypefabrikat&#39;</span><span class="p">],</span>
            <span class="n">all_fields</span><span class="p">[</span><span class="s1">&#39;MaalerTypeBetegnel&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">alt_place</span> <span class="ow">in</span> <span class="n">new_values</span><span class="p">:</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="n">new_values</span><span class="p">[</span><span class="n">alt_place</span><span class="p">]</span> <span class="k">if</span> <span class="n">new_values</span><span class="p">[</span><span class="n">alt_place</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">relations</span><span class="p">[</span><span class="s1">&#39;ava_opstillingsadresse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Relation</span><span class="p">(</span><span class="s1">&#39;uuid&#39;</span><span class="p">,</span> <span class="n">new_id</span><span class="p">))</span>

    <span class="n">write_object</span><span class="p">(</span><span class="n">uuid</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">relations</span><span class="p">,</span> <span class="s2">&quot;klassifikation&quot;</span><span class="p">,</span> <span class="s2">&quot;klasse&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_customer"><a class="viewcode-back" href="../crm_utils.html#crm_utils.update_customer">[docs]</a><span class="k">def</span> <span class="nf">update_customer</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">new_values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update customer with new information.&quot;&quot;&quot;</span>
    <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">relations</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="c1"># TODO: Replace this explicit mapping with an automation iterating through</span>
    <span class="c1"># property_fields and relation_fields. E.g., defining</span>
    <span class="c1">#   property_fields =  [&#39;KundeSagsnr&#39;]</span>
    <span class="c1">#   relation_fields = [&#39;Telefon&#39;, &#39;MobilTlf&#39;]</span>
    <span class="k">if</span> <span class="s1">&#39;KundeSagsnr&#39;</span> <span class="ow">in</span> <span class="n">new_values</span><span class="p">:</span>
        <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;ava_masterid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_values</span><span class="p">[</span><span class="s1">&#39;KundeSagsnr&#39;</span><span class="p">]</span>

    <span class="n">id_number</span> <span class="o">=</span> <span class="n">cpr_cvr</span><span class="p">(</span><span class="n">int_str</span><span class="p">(</span>
        <span class="n">new_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PersonnrSEnr&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PersonnrSEnr&#39;</span><span class="p">)</span>
    <span class="p">))</span>

    <span class="n">customer_uuid</span> <span class="o">=</span> <span class="n">lookup_customer</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">customer_uuid</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Customer </span><span class="si">{}</span><span class="s2"> not found when updating: ERROR&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">id_number</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">is_cpr</span><span class="p">(</span><span class="n">id_number</span><span class="p">):</span>
        <span class="n">customer_class</span> <span class="o">=</span> <span class="s2">&quot;bruger&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">customer_class</span> <span class="o">=</span> <span class="s2">&quot;organisation&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;MobilTlf&#39;</span> <span class="ow">in</span> <span class="n">new_values</span> <span class="ow">or</span> <span class="s1">&#39;Telefon&#39;</span> <span class="ow">in</span> <span class="n">new_values</span><span class="p">:</span>
        <span class="c1"># Handle the addresses - read the addresses</span>
        <span class="c1"># and replace mobile and telephone with the new ones</span>
        <span class="c1"># as appropriate.</span>
        <span class="n">customer</span> <span class="o">=</span> <span class="n">read_object</span><span class="p">(</span><span class="n">customer_uuid</span><span class="p">,</span> <span class="s2">&quot;organisation&quot;</span><span class="p">,</span> <span class="n">customer_class</span><span class="p">)</span>
        <span class="n">adresser</span> <span class="o">=</span> <span class="n">customer</span><span class="p">[</span><span class="s1">&#39;relationer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adresser&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">telephone_needed</span> <span class="o">=</span> <span class="s1">&#39;Telefon&#39;</span> <span class="ow">in</span> <span class="n">new_values</span>
        <span class="n">mobile_needed</span> <span class="o">=</span> <span class="s1">&#39;MobilTlf&#39;</span> <span class="ow">in</span> <span class="n">new_values</span>
        <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">adresser</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;uuid&quot;</span> <span class="ow">in</span> <span class="n">addr</span><span class="p">:</span>
                <span class="n">relations</span><span class="p">[</span><span class="s1">&#39;adresser&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Relation</span><span class="p">(</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span>
                                                      <span class="n">addr</span><span class="p">[</span><span class="s2">&quot;virkning&quot;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="s2">&quot;urn&quot;</span> <span class="ow">in</span> <span class="n">addr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">telephone_needed</span> <span class="ow">and</span> <span class="n">addr</span><span class="p">[</span><span class="s2">&quot;urn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;urn:tel&quot;</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">mobile_needed</span> <span class="ow">and</span> <span class="n">addr</span><span class="p">[</span><span class="s2">&quot;urn&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;urn:mobile&quot;</span><span class="p">):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">relations</span><span class="p">[</span><span class="s1">&#39;adresser&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Relation</span><span class="p">(</span><span class="s2">&quot;urn&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">[</span><span class="s2">&quot;urn&quot;</span><span class="p">],</span>
                                                          <span class="n">addr</span><span class="p">[</span><span class="s2">&quot;virkning&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">telephone_needed</span><span class="p">:</span>
            <span class="n">relations</span><span class="p">[</span><span class="s1">&#39;adresser&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Relation</span><span class="p">(</span><span class="s2">&quot;urn&quot;</span><span class="p">,</span> <span class="s2">&quot;urn:tel:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_values</span><span class="p">[</span><span class="s1">&#39;Telefon&#39;</span><span class="p">]))</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">mobile_needed</span><span class="p">:</span>
            <span class="n">relations</span><span class="p">[</span><span class="s1">&#39;adresser&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Relation</span><span class="p">(</span><span class="s2">&quot;urn&quot;</span><span class="p">,</span> <span class="s2">&quot;urn:mobile:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_values</span><span class="p">[</span><span class="s1">&#39;MobilTlf&#39;</span><span class="p">]))</span>
            <span class="p">)</span>

    <span class="n">write_object</span><span class="p">(</span><span class="n">customer_uuid</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">relations</span><span class="p">,</span> <span class="s2">&quot;organisation&quot;</span><span class="p">,</span>
                 <span class="n">customer_class</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_customer_relation"><a class="viewcode-back" href="../crm_utils.html#crm_utils.update_customer_relation">[docs]</a><span class="k">def</span> <span class="nf">update_customer_relation</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">new_values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update customer relation with the changed values.&quot;&quot;&quot;</span>
    <span class="n">address_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ForbrStVejnavn&#39;</span><span class="p">,</span> <span class="s1">&#39;Vejkode&#39;</span><span class="p">,</span> <span class="s1">&#39;Postnr&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;ForbrStPostdistrikt&#39;</span><span class="p">,</span> <span class="s1">&#39;Husnr&#39;</span><span class="p">,</span> <span class="s1">&#39;Bogstav&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;Etage&#39;</span><span class="p">,</span> <span class="s1">&#39;Sidedørnr&#39;</span><span class="p">]</span>
    <span class="n">customer_role_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PersonnrSEnr&#39;</span><span class="p">,</span> <span class="s1">&#39;LigestPersonnr&#39;</span><span class="p">]</span>
    <span class="n">customer_roles</span> <span class="o">=</span> <span class="p">[</span><span class="n">KUNDE</span><span class="p">,</span> <span class="n">LIGESTILLINGSKUNDE</span><span class="p">]</span>
    <span class="n">customer_number</span> <span class="o">=</span> <span class="n">int_str</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;Kundenr&#39;</span><span class="p">])</span>
    <span class="n">cr_uuid</span> <span class="o">=</span> <span class="n">lookup_customer_relation</span><span class="p">(</span><span class="n">customer_number</span><span class="p">)</span>
    <span class="n">customer_relation</span> <span class="o">=</span> <span class="n">read_object</span><span class="p">(</span><span class="n">cr_uuid</span><span class="p">,</span> <span class="s2">&quot;organisation&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;interessefaellesskab&quot;</span><span class="p">)</span>
    <span class="c1"># Dictionary of updated values - no need to exclusively check new_values.</span>
    <span class="n">new_fields</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">new_values</span><span class="p">}</span>

    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">address_fields</span><span class="p">):</span>
        <span class="c1"># If there&#39;s any change at all in address fields we need to recalculate</span>
        <span class="c1"># address to see if it&#39;s still correct.</span>
        <span class="c1"># NOTE: Normally this will be a spelling correction and should yield</span>
        <span class="c1"># the same address, but DAR addresses may actually change once in a</span>
        <span class="c1"># while.</span>

        <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">old_addresses</span> <span class="o">=</span> <span class="n">customer_relation</span><span class="p">[</span><span class="s1">&#39;relationer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;adresser&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">old_addresses</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">old_address_uuid</span> <span class="o">=</span> <span class="n">old_addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">old_addresses</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># Recalculate address &amp; set correct address link.</span>
        <span class="p">(</span><span class="n">new_address</span><span class="p">,</span>
         <span class="n">new_address_uuid</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_forbrugssted_address_uuid</span><span class="p">(</span><span class="n">new_fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_address_uuid</span><span class="p">:</span>
            <span class="n">report_error</span><span class="p">(</span><span class="n">new_address</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_address_uuid</span> <span class="ow">and</span> <span class="n">new_address_uuid</span> <span class="o">!=</span> <span class="n">old_address_uuid</span><span class="p">:</span>
            <span class="n">relations</span><span class="p">[</span><span class="s1">&#39;adresser&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Relation</span><span class="p">(</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="n">new_address_uuid</span><span class="p">)]</span>

        <span class="c1"># Recalculate customer relation name and set if it has changed.</span>
        <span class="c1"># Note: We exploit that these properties always have virkning to</span>
        <span class="c1"># infinity and that the current period is always the last.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_egenskaber</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">customer_relation</span><span class="p">[</span><span class="s2">&quot;attributter&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;interessefaellesskabegenskaber&quot;</span>
                <span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">elem</span><span class="p">:</span> <span class="n">elem</span><span class="p">[</span><span class="s1">&#39;virkning&#39;</span><span class="p">][</span><span class="s1">&#39;to&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">customer_relation</span><span class="p">[</span><span class="s2">&quot;attributter&quot;</span><span class="p">][</span>
                    <span class="s2">&quot;interessefaellesskabegenskaber&quot;</span><span class="p">])</span>
            <span class="c1"># This should *not* happen</span>
            <span class="k">raise</span>
        <span class="n">old_name</span> <span class="o">=</span> <span class="n">current_egenskaber</span><span class="p">[</span><span class="s2">&quot;interessefaellesskabsnavn&quot;</span><span class="p">]</span>
        <span class="n">new_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">VARME</span><span class="p">,</span> <span class="n">new_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">old_name</span> <span class="o">!=</span> <span class="n">new_name</span><span class="p">:</span>
            <span class="n">properties</span><span class="p">[</span><span class="s2">&quot;interessefaellesskabsnavn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_name</span>

        <span class="n">write_object</span><span class="p">(</span><span class="n">cr_uuid</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">relations</span><span class="p">,</span> <span class="s2">&quot;organisation&quot;</span><span class="p">,</span>
                     <span class="s2">&quot;interessefaellesskab&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">role</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">customer_role_fields</span><span class="p">,</span> <span class="n">customer_roles</span><span class="p">):</span>
        <span class="c1"># Handle customer role changes.</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">new_values</span><span class="p">:</span>
            <span class="n">old_customer_role</span> <span class="o">=</span> <span class="n">lookup_customer_role</span><span class="p">(</span><span class="n">cr_uuid</span><span class="p">,</span> <span class="n">role</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old_customer_role</span><span class="p">:</span>
                <span class="n">delete_customer_role</span><span class="p">(</span><span class="n">old_customer_role</span><span class="p">)</span>
            <span class="n">id_number</span> <span class="o">=</span> <span class="n">cpr_cvr</span><span class="p">(</span><span class="n">int_str</span><span class="p">(</span><span class="n">new_values</span><span class="p">[</span><span class="n">field</span><span class="p">]))</span>
            <span class="n">customer_uuid</span> <span class="o">=</span> <span class="n">lookup_customer</span><span class="p">(</span><span class="n">id_number</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">customer_uuid</span><span class="p">:</span>
                <span class="c1"># No such customer - we need to create one</span>
                <span class="n">master_id</span> <span class="o">=</span> <span class="n">int_str</span><span class="p">(</span><span class="n">new_fields</span><span class="p">[</span><span class="s1">&#39;KundeSagsnr&#39;</span><span class="p">])</span>
                <span class="n">customer_number</span> <span class="o">=</span> <span class="n">int_str</span><span class="p">(</span><span class="n">new_fields</span><span class="p">[</span><span class="s1">&#39;Kundenr&#39;</span><span class="p">])</span>

                <span class="n">customer_uuid</span> <span class="o">=</span> <span class="n">create_customer</span><span class="p">(</span>
                    <span class="n">id_number</span><span class="o">=</span><span class="n">id_number</span><span class="p">,</span>
                    <span class="n">key</span><span class="o">=</span><span class="n">customer_number</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">new_fields</span><span class="p">[</span><span class="s1">&#39;KundeNavn&#39;</span><span class="p">],</span>
                    <span class="n">master_id</span><span class="o">=</span><span class="n">master_id</span><span class="p">,</span>
                    <span class="n">phone</span><span class="o">=</span><span class="n">new_fields</span><span class="p">[</span><span class="s1">&#39;Telefonnr&#39;</span><span class="p">],</span>
                    <span class="n">email</span><span class="o">=</span><span class="n">new_fields</span><span class="p">[</span><span class="s1">&#39;EmailKunde&#39;</span><span class="p">],</span>
                    <span class="n">mobile</span><span class="o">=</span><span class="n">new_fields</span><span class="p">[</span><span class="s1">&#39;MobilTlf&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">customer_uuid</span><span class="p">:</span>
                <span class="n">report_error</span><span class="p">(</span><span class="s2">&quot;Unable to lookup or create customer </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">field</span>
                <span class="p">))</span>
                <span class="k">return</span>
            <span class="n">create_customer_role</span><span class="p">(</span><span class="n">customer_uuid</span><span class="p">,</span> <span class="n">cr_uuid</span><span class="p">,</span> <span class="n">KUNDE</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_agreement"><a class="viewcode-back" href="../crm_utils.html#crm_utils.update_agreement">[docs]</a><span class="k">def</span> <span class="nf">update_agreement</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">new_values</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update agreement based on the changed fields.&quot;&quot;&quot;</span>
    <span class="n">address_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Vejnavn&#39;</span><span class="p">,</span> <span class="s1">&#39;Postdistrikt&#39;</span><span class="p">]</span>
    <span class="n">date_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Tilflytningsdato&#39;</span><span class="p">,</span> <span class="s1">&#39;Fraflytningsdato&#39;</span><span class="p">]</span>
    <span class="n">date_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;startdato&#39;</span><span class="p">,</span> <span class="s1">&#39;slutdato&#39;</span><span class="p">]</span>
    <span class="n">new_fields</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">new_values</span><span class="p">}</span>

    <span class="c1"># Look up agreement, we know we&#39;re going to need this.</span>
    <span class="n">customer_number</span> <span class="o">=</span> <span class="n">int_str</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s1">&#39;Kundenr&#39;</span><span class="p">])</span>
    <span class="n">cr_uuid</span> <span class="o">=</span> <span class="n">lookup_customer_relation</span><span class="p">(</span><span class="n">customer_number</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cr_uuid</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Customer not found when updating agreement:&quot;</span><span class="p">,</span> <span class="n">customer_number</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># The should be one and only one agreement for each CR.</span>
    <span class="n">agreements</span> <span class="o">=</span> <span class="n">lookup_agreements</span><span class="p">(</span><span class="n">cr_uuid</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">agreements</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">agreement_uuid</span> <span class="o">=</span> <span class="n">agreements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Agreement not found for customer:&quot;</span><span class="p">,</span> <span class="n">customer_number</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">relations</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">address_fields</span><span class="p">):</span>
        <span class="c1"># Handle possible new invoicing address</span>
        <span class="n">invoice_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_fields</span><span class="p">[</span><span class="s1">&#39;VejNavn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,-&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="o">+</span>
                           <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">new_fields</span><span class="p">[</span><span class="s1">&#39;Postdistrikt&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">invoice_address_uuid</span> <span class="o">=</span> <span class="n">fuzzy_address_uuid</span><span class="p">(</span><span class="n">invoice_address</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">invoice_address_uuid</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">report_error</span><span class="p">(</span>
                <span class="s2">&quot;Customer </span><span class="si">{1}</span><span class="s2">: Unable to lookup invoicing address: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">customer_number</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">invoice_address_uuid</span><span class="p">:</span>
            <span class="n">relations</span><span class="p">[</span><span class="s1">&#39;indsatsdokument&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Relation</span><span class="p">(</span><span class="s2">&quot;uuid&quot;</span><span class="p">,</span> <span class="n">invoice_address_uuid</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="c1"># Now handle the date change(s).</span>
    <span class="n">tz</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="s1">&#39;Europe/Copenhagen&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="nb">property</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">date_fields</span><span class="p">,</span> <span class="n">date_properties</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">new_values</span><span class="p">:</span>
            <span class="n">date_str</span> <span class="o">=</span> <span class="n">new_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">tz</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa</span>
                <span class="c1"># This is only for Max date - which is 9999-12-31 =~ infinity</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
            <span class="n">properties</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

    <span class="c1"># Update agreement if we arrived at any changes.</span>
    <span class="k">if</span> <span class="n">relations</span> <span class="ow">or</span> <span class="n">properties</span><span class="p">:</span>
        <span class="n">write_object</span><span class="p">(</span>
            <span class="n">agreement_uuid</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">relations</span><span class="p">,</span> <span class="s2">&quot;indsats&quot;</span><span class="p">,</span> <span class="s2">&quot;indsats&quot;</span>
        <span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Magenta ApS.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>